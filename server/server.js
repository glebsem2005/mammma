const express = require('express');
const http = require('http');
const socketIo = require('socket.io');
const cors = require('cors');

const app = express();
const server = http.createServer(app);
const io = socketIo(server, {
  cors: {
    origin: "*",
    methods: ["GET", "POST"]
  }
});

app.use(cors());
app.use(express.json());

// –•—Ä–∞–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –∫–æ–º–Ω–∞—Ç
const activeUsers = new Map();
const activeRooms = new Map();

console.log('üöÄ –ó–∞–ø—É—Å–∫ WebRTC —Å–∏–≥–Ω–∞–ª–∏–Ω–≥–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞...');

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
io.on('connection', (socket) => {
  console.log(`üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è: ${socket.id}`);
  
  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  socket.on('register', (data) => {
    const { userId } = data;
    activeUsers.set(userId, {
      socketId: socket.id,
      socket: socket,
      isInCall: false,
      currentRoom: null
    });
    
    console.log(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: ${userId}`);
    
    // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
    socket.broadcast.emit('user_online', { userId });
  });

  // –ò–Ω–∏—Ü–∏–∞—Ü–∏—è –∑–≤–æ–Ω–∫–∞
  socket.on('call_user', (data) => {
    const { targetUserId, callType, offer } = data;
    console.log(`üìû –ó–≤–æ–Ω–æ–∫ –æ—Ç ${data.callerId || socket.id} –∫ ${targetUserId}`);
    
    const targetUser = activeUsers.get(targetUserId);
    
    if (!targetUser) {
      socket.emit('call_error', { error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –æ—Ñ–ª–∞–π–Ω' });
      return;
    }

    if (targetUser.isInCall) {
      socket.emit('call_error', { error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–Ω—è—Ç' });
      return;
    }

    const roomId = `call_${socket.id}_${targetUserId}_${Date.now()}`;
    
    // –°–æ–∑–¥–∞–µ–º –∫–æ–º–Ω–∞—Ç—É –¥–ª—è –∑–≤–æ–Ω–∫–∞
    activeRooms.set(roomId, {
      participants: [socket.id, targetUserId],
      callType: callType,
      initiator: socket.id,
      startTime: new Date(),
      status: 'ringing'
    });

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞
    targetUser.socket.emit('incoming_call', {
      callerId: socket.id,
      roomId: roomId,
      callType: callType,
      offer: offer
    });

    // –£–≤–µ–¥–æ–º–ª—è–µ–º –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–∞
    socket.emit('call_initiated', { roomId });
    
    console.log(`üîî –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –∫–æ–º–Ω–∞—Ç—É ${roomId}`);
  });

  // –ü—Ä–∏–Ω—è—Ç–∏–µ –∑–≤–æ–Ω–∫–∞
  socket.on('accept_call', (data) => {
    const { roomId, answer } = data;
    console.log(`‚úÖ –ó–≤–æ–Ω–æ–∫ –ø—Ä–∏–Ω—è—Ç –≤ –∫–æ–º–Ω–∞—Ç–µ ${roomId}`);
    
    const room = activeRooms.get(roomId);
    if (!room) {
      socket.emit('call_error', { error: '–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞' });
      return;
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
    room.status = 'active';
    room.acceptTime = new Date();

    // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º –∫ –∫–æ–º–Ω–∞—Ç–µ
    socket.join(roomId);
    
    // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–∞ –∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º –µ–≥–æ —Ç–æ–∂–µ
    const initiatorSocketId = room.initiator;
    const initiatorSocket = io.sockets.sockets.get(initiatorSocketId);
    if (initiatorSocket) {
      initiatorSocket.join(roomId);
      initiatorSocket.emit('call_accepted', { roomId, answer });
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    room.participants.forEach(participantId => {
      const user = [...activeUsers.values()].find(u => u.socketId === participantId);
      if (user) {
        user.isInCall = true;
        user.currentRoom = roomId;
      }
    });
    
    console.log(`üéâ –ó–≤–æ–Ω–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω –≤ –∫–æ–º–Ω–∞—Ç–µ ${roomId}`);
  });

  // –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞
  socket.on('decline_call', (data) => {
    const { roomId } = data;
    console.log(`‚ùå –ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω –≤ –∫–æ–º–Ω–∞—Ç–µ ${roomId}`);
    
    const room = activeRooms.get(roomId);
    if (room) {
      const initiatorSocketId = room.initiator;
      const initiatorSocket = io.sockets.sockets.get(initiatorSocketId);
      if (initiatorSocket) {
        initiatorSocket.emit('call_declined', { roomId });
      }
      activeRooms.delete(roomId);
    }
  });

  // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞
  socket.on('end_call', (data) => {
    const { roomId } = data;
    console.log(`üì¥ –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω –≤ –∫–æ–º–Ω–∞—Ç–µ ${roomId}`);
    
    const room = activeRooms.get(roomId);
    if (room) {
      // –£–≤–µ–¥–æ–º–ª—è–µ–º –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
      io.to(roomId).emit('call_ended', { roomId });
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
      room.participants.forEach(participantId => {
        const user = [...activeUsers.values()].find(u => u.socketId === participantId);
        if (user) {
          user.isInCall = false;
          user.currentRoom = null;
        }
      });
      
      activeRooms.delete(roomId);
    }
  });

  // –û–±–º–µ–Ω ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º–∏
  socket.on('ice_candidate', (data) => {
    const { roomId, candidate } = data;
    socket.to(roomId).emit('ice_candidate', {
      candidate: candidate,
      from: socket.id
    });
  });

  // –û–±–º–µ–Ω SDP
  socket.on('sdp_exchange', (data) => {
    const { roomId, sdp, type } = data;
    socket.to(roomId).emit('sdp_exchange', {
      sdp: sdp,
      type: type,
      from: socket.id
    });
  });

  // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–µ–¥–∏–∞
  socket.on('media_state_change', (data) => {
    const { roomId, mediaState } = data;
    socket.to(roomId).emit('media_state_change', {
      userId: socket.id,
      mediaState: mediaState
    });
  });

  // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  socket.on('disconnect', (reason) => {
    console.log(`üëã –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª—é—á–∏–ª—Å—è: ${socket.id}, –ø—Ä–∏—á–∏–Ω–∞: ${reason}`);
    
    // –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let disconnectedUserId = null;
    for (const [userId, userData] of activeUsers.entries()) {
      if (userData.socketId === socket.id) {
        disconnectedUserId = userId;
        
        // –ï—Å–ª–∏ –±—ã–ª –≤ –∑–≤–æ–Ω–∫–µ, –∑–∞–≤–µ—Ä—à–∞–µ–º –µ–≥–æ
        if (userData.currentRoom) {
          const room = activeRooms.get(userData.currentRoom);
          if (room) {
            io.to(userData.currentRoom).emit('call_ended', {
              roomId: userData.currentRoom,
              reason: 'disconnect'
            });
            activeRooms.delete(userData.currentRoom);
          }
        }
        
        activeUsers.delete(userId);
        break;
      }
    }
    
    if (disconnectedUserId) {
      socket.broadcast.emit('user_offline', { userId: disconnectedUserId });
    }
  });
});

// API –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
app.get('/api/stats', (req, res) => {
  res.json({
    activeUsers: activeUsers.size,
    activeRooms: activeRooms.size,
    timestamp: new Date().toISOString()
  });
});

app.get('/api/health', (req, res) => {
  res.json({ 
    status: 'OK',
    uptime: process.uptime(),
    timestamp: new Date().toISOString()
  });
});

// –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
const PORT = process.env.PORT || 3001;
server.listen(PORT, () => {
  console.log(`üöÄ WebRTC —Å–∏–≥–Ω–∞–ª–∏–Ω–≥–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}`);
  console.log(`üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: http://localhost:${PORT}/api/stats`);
  console.log(`‚ù§Ô∏è  –ó–¥–æ—Ä–æ–≤—å–µ: http://localhost:${PORT}/api/health`);
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
process.on('uncaughtException', (error) => {
  console.error('üí• –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞:', error);
});

process.on('unhandledRejection', (reason, promise) => {
  console.error('üí• –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–∏—Å–∞:', reason);
});

module.exports = app;const express = require('express');
const http = require('http');
const socketIo = require('socket.io');
const cors = require('cors');

const app = express();
const server = http.createServer(app);
const io = socketIo(server, {
  cors: {
    origin: "*",
    methods: ["GET", "POST"]
  }
});

app.use(cors());
app.use(express.json());

// –•—Ä–∞–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
const activeUsers = new Map();
const activeRooms = new Map();

// Middleware –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω—É–∂–Ω–∞ –ø–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
const authenticateSocket = (socket, next) => {
  const token = socket.handshake.auth.token;
  if (!token) {
    return next(new Error('Authentication error'));
  }
  
  // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ JWT —Ç–æ–∫–µ–Ω–∞
  socket.userId = socket.handshake.auth.userId;
  next();
};

io.use(authenticateSocket);

io.on('connection', (socket) => {
  console.log(`User connected: ${socket.userId}`);
  
  // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  activeUsers.set(socket.userId, {
    socketId: socket.id,
    socket: socket,
    isInCall: false,
    currentRoom: null
  });

  // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
  socket.broadcast.emit('user_online', {
    userId: socket.userId,
    timestamp: new Date().toISOString()
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–Ω–∏—Ü–∏–∞—Ü–∏–∏ –∑–≤–æ–Ω–∫–∞
  socket.on('call_user', (data) => {
    const { targetUserId, callType, offer } = data;
    const targetUser = activeUsers.get(targetUserId);
    
    if (!targetUser) {
      socket.emit('call_error', { error: 'User not found or offline' });
      return;
    }

    if (targetUser.isInCall) {
      socket.emit('call_error', { error: 'User is busy' });
      return;
    }

    const roomId = `call_${socket.userId}_${targetUserId}`;
    
    // –°–æ–∑–¥–∞–µ–º –∫–æ–º–Ω–∞—Ç—É –¥–ª—è –∑–≤–æ–Ω–∫–∞
    activeRooms.set(roomId, {
      participants: [socket.userId, targetUserId],
      callType: callType,
      initiator: socket.userId,
      startTime: new Date().toISOString(),
      status: 'ringing'
    });

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞
    targetUser.socket.emit('incoming_call', {
      callerId: socket.userId,
      roomId: roomId,
      callType: callType,
      offer: offer
    });

    // –£–≤–µ–¥–æ–º–ª—è–µ–º –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–∞ –æ —Ç–æ–º, —á—Ç–æ –∑–≤–æ–Ω–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
    socket.emit('call_initiated', {
      roomId: roomId,
      targetUserId: targetUserId
    });
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–≤–æ–Ω–∫–∞
  socket.on('accept_call', (data) => {
    const { roomId, answer } = data;
    const room = activeRooms.get(roomId);
    
    if (!room) {
      socket.emit('call_error', { error: 'Room not found' });
      return;
    }

    const initiatorId = room.initiator;
    const initiator = activeUsers.get(initiatorId);
    
    if (!initiator) {
      socket.emit('call_error', { error: 'Initiator not found' });
      return;
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    activeUsers.get(socket.userId).isInCall = true;
    activeUsers.get(socket.userId).currentRoom = roomId;
    activeUsers.get(initiatorId).isInCall = true;
    activeUsers.get(initiatorId).currentRoom = roomId;

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–º–Ω–∞—Ç—ã
    room.status = 'active';
    room.acceptTime = new Date().toISOString();

    // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫ –∫–æ–º–Ω–∞—Ç–µ
    socket.join(roomId);
    initiator.socket.join(roomId);

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä—É
    initiator.socket.emit('call_accepted', {
      roomId: roomId,
      answer: answer
    });
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞
  socket.on('decline_call', (data) => {
    const { roomId, reason } = data;
    const room = activeRooms.get(roomId);
    
    if (!room) {
      return;
    }

    const initiatorId = room.initiator;
    const initiator = activeUsers.get(initiatorId);
    
    if (initiator) {
      initiator.socket.emit('call_declined', {
        roomId: roomId,
        reason: reason || 'declined'
      });
    }

    // –£–¥–∞–ª—è–µ–º –∫–æ–º–Ω–∞—Ç—É
    activeRooms.delete(roomId);
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞
  socket.on('end_call', (data) => {
    const { roomId } = data;
    const room = activeRooms.get(roomId);
    
    if (!room) {
      return;
    }

    // –£–≤–µ–¥–æ–º–ª—è–µ–º –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–≤–æ–Ω–∫–∞
    room.participants.forEach(userId => {
      const user = activeUsers.get(userId);
      if (user) {
        user.socket.emit('call_ended', {
          roomId: roomId,
          endedBy: socket.userId
        });
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∑–≤–æ–Ω–∫–∞
        user.isInCall = false;
        user.currentRoom = null;
        user.socket.leave(roomId);
      }
    });

    // –£–¥–∞–ª—è–µ–º –∫–æ–º–Ω–∞—Ç—É
    activeRooms.delete(roomId);
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
  socket.on('ice_candidate', (data) => {
    const { roomId, candidate } = data;
    const room = activeRooms.get(roomId);
    
    if (!room) {
      return;
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –¥—Ä—É–≥–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
    socket.to(roomId).emit('ice_candidate', {
      candidate: candidate,
      from: socket.userId
    });
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–º–µ–Ω–∞ SDP
  socket.on('sdp_exchange', (data) => {
    const { roomId, sdp, type } = data;
    const room = activeRooms.get(roomId);
    
    if (!room) {
      return;
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º SDP –¥—Ä—É–≥–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
    socket.to(roomId).emit('sdp_exchange', {
      sdp: sdp,
      type: type,
      from: socket.userId
    });
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –º–µ–¥–∏–∞ (–≤–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã, –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞)
  socket.on('media_state_change', (data) => {
    const { roomId, mediaState } = data;
    const room = activeRooms.get(roomId);
    
    if (!room) {
      return;
    }

    // –£–≤–µ–¥–æ–º–ª—è–µ–º –¥—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏
    socket.to(roomId).emit('media_state_change', {
      userId: socket.userId,
      mediaState: mediaState
    });
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  socket.on('disconnect', (reason) => {
    console.log(`User disconnected: ${socket.userId}, reason: ${reason}`);
    
    const user = activeUsers.get(socket.userId);
    if (user && user.currentRoom) {
      // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã–ª –≤ –∑–≤–æ–Ω–∫–µ, –∑–∞–≤–µ—Ä—à–∞–µ–º –µ–≥–æ
      const room = activeRooms.get(user.currentRoom);
      if (room) {
        // –£–≤–µ–¥–æ–º–ª—è–µ–º –¥—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        room.participants.forEach(userId => {
          if (userId !== socket.userId) {
            const otherUser = activeUsers.get(userId);
            if (otherUser) {
              otherUser.socket.emit('call_ended', {
                roomId: user.currentRoom,
                endedBy: socket.userId,
                reason: 'disconnect'
              });
              otherUser.isInCall = false;
              otherUser.currentRoom = null;
            }
          }
        });
        
        activeRooms.delete(user.currentRoom);
      }
    }

    // –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö
    activeUsers.delete(socket.userId);
    
    // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏
    socket.broadcast.emit('user_offline', {
      userId: socket.userId,
      timestamp: new Date().toISOString()
    });
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  socket.on('get_online_users', () => {
    const onlineUsers = Array.from(activeUsers.keys());
    socket.emit('online_users', onlineUsers);
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  socket.on('check_user_status', (data) => {
    const { userId } = data;
    const user = activeUsers.get(userId);
    
    socket.emit('user_status', {
      userId: userId,
      isOnline: !!user,
      isInCall: user ? user.isInCall : false
    });
  });
});

// REST API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
app.get('/api/health', (req, res) => {
  res.json({ 
    status: 'OK', 
    timestamp: new Date().toISOString(),
    activeUsers: activeUsers.size,
    activeRooms: activeRooms.size
  });
});

app.get('/api/stats', (req, res) => {
  res.json({
    activeUsers: activeUsers.size,
    activeRooms: activeRooms.size,
    rooms: Array.from(activeRooms.entries()).map(([id, room]) => ({
      id,
      participants: room.participants.length,
      callType: room.callType,
      status: room.status,
      duration: room.acceptTime ? 
        Date.now() - new Date(room.acceptTime).getTime() : 
        Date.now() - new Date(room.startTime).getTime()
    }))
  });
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).json({ error: 'Something went wrong!' });
});

// –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
const PORT = process.env.PORT || 3001;
server.listen(PORT, () => {
  console.log(`WebRTC Signaling Server running on port ${PORT}`);
  console.log(`Health check: http://localhost:${PORT}/api/health`);
  console.log(`Stats: http://localhost:${PORT}/api/stats`);
});

// Graceful shutdown
process.on('SIGTERM', () => {
  console.log('SIGTERM received, shutting down gracefully');
  server.close(() => {
    console.log('Server closed');
    process.exit(0);
  });
});

process.on('SIGINT', () => {
  console.log('SIGINT received, shutting down gracefully');
  server.close(() => {
    console.log('Server closed');
    process.exit(0);
  });
});

module.exports = app;
